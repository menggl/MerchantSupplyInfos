<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>填写求购信息</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f2f3f5; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; }
        .phone-frame { width: 375px; height: 667px; background-color: #f7f8fa; border-radius: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; position: relative; border: 12px solid #333; }
        
        /* Navigation Bar */
        .nav-bar { background-color: #1890FF; padding: 44px 15px 10px; display: flex; align-items: center; justify-content: space-between; color: #fff; flex-shrink: 0; position: relative; }
        .nav-left { display: flex; align-items: center; flex: 1; }
        .nav-back { font-size: 24px; cursor: pointer; margin-right: 15px; font-weight: bold; }
        .nav-title { font-size: 16px; font-weight: 600; position: absolute; left: 50%; transform: translateX(-50%); text-align: center; letter-spacing: -0.2px; }
        .nav-btn { color: #fff; font-size: 14px; cursor: pointer; border: none; background: none; padding: 5px; font-weight: 400; }
        
        .content { flex: 1; overflow-y: auto; padding: 12px 16px; }
        
        /* Typography & Layout */
        .section-title { font-size: 12px; color: #858c96; margin: 16px 0 6px 4px; font-weight: 500; letter-spacing: 0.1px; }
        .section-title:first-child { margin-top: 4px; }
        
        .card { background: #fff; border-radius: 12px; padding: 0 16px; margin-bottom: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.02); overflow: hidden; }
        
        /* Type Toggle (right-aligned, consistent with value fields) */
        .type-toggle { display: flex; gap: 8px; margin: 16px 0 6px; padding: 0; flex: 1; justify-content: flex-end; background: transparent; }
        .type-btn { min-width: 87px; padding: 6px 12px; height: 32px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; cursor: pointer; border: 1px solid #d9dfe7; background: #f5f7fa; color: #333; white-space: nowrap; }
        .type-btn.active { background: #ffffff; color: #4facfe; border-color: #4facfe; }

        /* Selected Product Card - Special Styling */
        .selected-product { padding: 16px; background: #fff; border: none; margin-bottom: 0; }
        .sp-model { font-size: 13px; font-weight: 600; color: #2f3a4b; margin-bottom: 4px; letter-spacing: 0; line-height: 1.35; word-break: break-word; white-space: normal; }
        .sp-sep { color: #c4c8d0; margin: 0 4px; font-weight: 600; }
        .sp-seg { color: #2f3a4b; }
        .sp-detail { font-size: 12px; color: #5c6b7f; display: flex; align-items: center; font-weight: 400; }
        .sp-detail::before { content: ''; display: inline-block; width: 5px; height: 5px; background: #4facfe; border-radius: 50%; margin-right: 6px; }

        /* Form Rows */
        .form-row { display: flex; align-items: center; min-height: 48px; border-bottom: 0.5px solid #f2f2f2; }
        .form-row:last-child { border-bottom: none; }
        
        .form-label { width: 80px; font-size: 14px; color: #333; font-weight: 500; letter-spacing: -0.1px; }
        
        .form-input { flex: 1; border: none; font-size: 14px; color: #1a1a1a; outline: none; text-align: right; background: transparent; font-family: inherit; font-weight: 400; }
        .form-input::placeholder { color: #c4c8d0; font-weight: 400; }
        
        /* Price Inputs */
        .price-group { display: flex; align-items: center; flex: 1; justify-content: flex-end; gap: 6px; }
        .price-input { width: 70px; text-align: center; border: none; background: #f5f7fa; border-radius: 6px; padding: 6px 0; font-size: 12px; outline: none; color: #333; font-weight: 500; }
        .price-input:focus { background: #eef2f7; color: #4facfe; }
        .price-sep { color: #c4c8d0; font-weight: bold; font-size: 12px; }

        /* Publish Button */
        .btn-publish { width: 100%; height: 44px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 22px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 24px; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.2); letter-spacing: 0.5px; transition: transform 0.1s; }
        .btn-publish:active { transform: scale(0.98); opacity: 0.9; }

        /* Textarea override */
        textarea.form-input { padding: 12px 0; text-align: left; line-height: 1.4; resize: none; }

        /* Photos */
        .photo-grid { display: flex; flex-wrap: wrap; gap: 8px; padding: 12px 0; }
        .photo-item { width: calc((100% - 16px) / 3); aspect-ratio: 1 / 1; border-radius: 8px; overflow: hidden; position: relative; background: #f5f7fa; display: flex; align-items: center; justify-content: center; }
        .photo-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .photo-add { border: 1px dashed #cfd8e3; color: #9aa5b1; font-size: 24px; cursor: pointer; }
        .photo-remove { position: absolute; top: 6px; right: 6px; width: 20px; height: 20px; border-radius: 10px; background: rgba(0,0,0,0.45); color: #fff; font-size: 14px; line-height: 20px; text-align: center; cursor: pointer; }
        #photo-input { display: none; }

        /* Bottom Tab Bar */
        .tab-bar { height: 83px; background-color: #fff; border-top: 1px solid #e5e5e5; display: flex; padding-bottom: 20px; position: relative; z-index: 10; flex-shrink: 0; }
        .tab-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #999; cursor: pointer; font-size: 10px; }
        .tab-item.active { color: #4facfe; }
        .tab-icon { width: 24px; height: 24px; margin-bottom: 4px; background-color: currentColor; mask-size: contain; -webkit-mask-size: contain; mask-repeat: no-repeat; -webkit-mask-repeat: no-repeat; mask-position: center; -webkit-mask-position: center; }
        
        /* Icons */
        .icon-home { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E"); }
        .icon-search { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E"); }
        .icon-request { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z'/%3E%3C/svg%3E"); }
        .icon-me { -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"); mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"); }

        /* Bottom Sheet */
        .sheet-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; opacity: 0; transition: opacity 0.3s; }
        .sheet-overlay.visible { display: block; opacity: 1; }
        .sheet-content { position: absolute; left: 0; right: 0; bottom: 0; background: #fff; border-radius: 16px 16px 0 0; z-index: 1000; transform: translateY(100%); transition: transform 0.3s; max-height: 60vh; display: flex; flex-direction: column; }
        .sheet-content.visible { transform: translateY(0); }
        .sheet-header { padding: 16px; text-align: center; border-bottom: 1px solid #eee; position: relative; }
        .sheet-title { font-size: 16px; font-weight: 600; color: #333; }
        .sheet-close { position: absolute; right: 16px; top: 16px; font-size: 20px; color: #999; line-height: 1; cursor: pointer; }
        .sheet-body { overflow-y: auto; flex: 1; padding-bottom: 20px; }
        .sheet-option { padding: 16px; text-align: center; border-bottom: 1px solid #f5f5f5; font-size: 15px; color: #333; }
        .sheet-option:active { background: #f9f9f9; }

        /* Horizontal Scroll Selectors */
        .scroll-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            width: 100%;
            flex: 1;
            mask-image: linear-gradient(to right, transparent, black 15px, black calc(100% - 15px), transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 15px, black calc(100% - 15px), transparent);
            cursor: grab;
            user-select: none;
        }
        .scroll-container::-webkit-scrollbar { display: none; }
        .scroll-container.dragging { cursor: grabbing; }
        
        .scroll-item {
            flex: 0 0 auto;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 13px;
            background: #f1f3f5;
            color: #333;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .scroll-item.active {
            background: #ffd84d;
            color: #1a1a1a;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(255, 200, 0, 0.25);
        }
        
        .form-row.column-layout {
            flex-direction: column;
            align-items: flex-start;
            padding: 12px 0;
            height: auto;
            border-bottom: 0.5px solid #f2f2f2;
        }
        .form-row.column-layout .form-label {
            margin-bottom: 10px;
            width: 100%;
            font-size: 14px;
            font-weight: 500;
        }
        .form-row.inline-layout {
            flex-direction: row;
            align-items: center;
            padding: 12px 0;
            height: auto;
            border-bottom: 0.5px solid #f2f2f2;
        }
        .form-row.inline-layout .form-label {
            margin-bottom: 0;
            width: 80px;
            font-size: 14px;
            font-weight: 500;
        }
        .sub-label { font-size: 11px; color: #9aa5b1; margin-left: 6px; }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="nav-bar">
            <div class="nav-left">
                <div class="nav-back" onclick="history.back()">←</div>
            </div>
            <div class="nav-title">填写求购信息</div>
            <div style="width: 32px;"></div>
        </div>
        <div class="content">
            <div class="section-title">已选机型</div>
            <div class="card selected-product">
                <div class="sp-model" id="display-model"></div>
                <div class="sp-detail" id="display-detail"></div>
            </div>

            <div class="section-title" id="photo-section-title">商品图片</div>
            <div class="card" id="photo-card">
                <div class="photo-grid" id="photo-grid"></div>
                <input type="file" id="photo-input" accept="image/*" capture="environment" multiple>
            </div>

            <div class="section-title" id="detail-section-title">求购详情</div>
            <div class="card">
                <div class="form-row" id="row-type">
                    <label class="form-label">类型</label>
                    <div class="type-toggle" id="type-toggle" style="display: none;">
                        <div class="type-btn used" id="btn-type-used" onclick="toggleType('used')">二手机</div>
                        <div class="type-btn new" id="btn-type-new" onclick="toggleType('new')">新机</div>
                    </div>
                </div>
                <div class="form-row" id="row-quantity">
                    <label class="form-label" id="label-quantity">求购数量</label>
                    <input type="number" class="form-input" placeholder="请输入台数" id="quantity">
                </div>
                <div class="form-row" id="row-price-range">
                    <label class="form-label" id="label-price-range">价格范围</label>
                    <div class="price-group">
                        <input type="number" class="price-input" placeholder="最低价" id="min-price">
                        <span class="price-sep">-</span>
                        <input type="number" class="price-input" placeholder="最高价" id="max-price">
                    </div>
                </div>
                <div class="form-row" id="row-sell-price" style="display:none;">
                    <label class="form-label">售价</label>
                    <input type="number" class="form-input" placeholder="请输入售价" id="sell-price">
                </div>
                <div class="form-row inline-layout" id="row-used-version" style="display:none;">
                    <label class="form-label">版本</label>
                    <div class="scroll-container" id="container-version"></div>
                </div>
                <div class="form-row inline-layout" id="row-used-condition" style="display:none;">
                    <label class="form-label">成色</label>
                    <div class="scroll-container" id="container-condition"></div>
                </div>
                <div class="form-row inline-layout" id="row-used-repair" style="display:none;">
                    <label class="form-label">拆修和功能</label>
                    <div class="scroll-container" id="container-repair"></div>
                </div>
                <div class="form-row" id="row-remark" style="display:none;">
                    <label class="form-label">备注</label>
                    <input type="text" class="form-input" id="remark" placeholder="请选择备注" readonly onclick="openRemarkSheet()">
                </div>
                <div class="form-row" id="row-other" style="display:none;">
                    <label class="form-label">其它</label>
                    <input type="text" class="form-input" id="other" placeholder="请选择其它" readonly onclick="openOtherSheet()">
                </div>
                <div class="form-row" id="row-deadline">
                    <label class="form-label">截止时间</label>
                    <input type="datetime-local" class="form-input" id="deadline" style="color: #666;">
                </div>
                <div class="form-row" style="border-bottom: none; min-height: auto; margin-top: 8px; justify-content: flex-end;">
                    <div id="points-hint" style="font-size: 12px; color: #1890FF; padding: 6px 10px; border-radius: 4px; display: inline-flex; align-items: center;">
                        <svg viewBox="0 0 24 24" style="width: 14px; height: 14px; margin-right: 4px; fill: currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                        发送求购信息需扣除 20 积分
                    </div>
                </div>
            </div>

            

            <button class="btn-publish" id="btn-publish" onclick="publish()">确认发布</button>
        </div>

        <div class="tab-bar">
            <div class="tab-item" onclick="location.href='home_mockup.html'">
                <div class="tab-icon icon-home"></div>
                <span>首页</span>
            </div>
            <div class="tab-item" onclick="location.href='search_mockup.html'">
                <div class="tab-icon icon-search"></div>
                <span>查询</span>
            </div>
            <div class="tab-item" onclick="location.href='listings_mockup.html'">
                <div class="tab-icon icon-request"></div>
                <span>求购</span>
            </div>
            <div class="tab-item" onclick="location.href='me_mockup.html'">
                <div class="tab-icon icon-me"></div>
                <span>我的</span>
            </div>
        </div>
        
        <!-- Bottom Sheet -->
        <div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
        <div class="sheet-content" id="sheet-content">
            <div class="sheet-header">
                <div class="sheet-title" id="sheet-title">标题</div>
                <div class="sheet-close" onclick="closeSheet()">×</div>
            </div>
            <div class="sheet-body" id="sheet-body">
                <!-- Options will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Parse URL params
        const params = new URLSearchParams(window.location.search);
        const brand = params.get('brand');
        const series = params.get('series');
        const model = params.get('model');
        const config = params.get('config');
        const mode = params.get('mode') || 'request';
        const type = params.get('type') || '';
        const action = params.get('action') || '';
        const initStock = params.get('initStock') || '';
        const initMinPrice = params.get('initMinPrice') || '';
        const initQty = params.get('initQty') || '';
        const initMaxPrice = params.get('initMaxPrice') || '';
        const initDeadline = params.get('initDeadline') || '';
        
        // Constants for options
        const remarkOptions = [ '保证省内纯原', '保证全国纯原', '省内拆封激活', '全国拆封激活', '省内拆封未激活', '全国拆封未激活', '全国纯原怕查', '全国纯原不怕串', '官网纯原封预激活', '公司纯原封', '公司纯原不怕串', '纯原带AC+预激活', '公司纯原带活动', '代发', '全国纯原', '省内纯原' ];
        const otherOptions = [ '默认', '禁止出省', '可出全国', '禁出线上', '包邮', '怕串', '不怕串', '包装瑕疵', '机器瑕疵', '带AC+', '权益版', '联通定制', '电信定制', '移动定制', '教育机', '政企定制', '官换机', '演示机', '含税', 'TD鼎桥版', '现货当面激活', '带碎屏险', '官翻全国联保', '提供激活照片', '当天激活发出', '特定区域销售', '现货', '盒子刮码', '牛皮外箱无或开封', '可过串' ];
        
        const versionOptions = ['大陆国行', '海外无锁', '海外有锁', '其他版本', '香港行货', '国行官换/官修机'];
        const conditionOptions = ['全新未拆封', '几乎全新', '细微磕碰划痕', '少量磕碰划痕', '轻度磕碰划痕', '严重磕碰划痕', '屏幕破损或外壳破碎', '屏幕深度划伤或色差', '屏幕发黄/透色/色斑'];
        const repairOptions = ['无任何维修', '屏幕有维修', '更换电池', '外壳/摄像头有维修', '功能明显异常', '零件有维修', '主板有维修', '功能有轻度异常'];

        // State for new used phone fields
        let selectedVersion = '';
        let selectedCondition = '';
        let selectedRepairs = new Set(); // Multi-select
        let mouseDragActive = false; // Guard to avoid selecting while dragging

        // Scrollable Options Rendering Logic
        function renderScrollOptions(containerId, options, selectedValue, onSelect) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = `scroll-item ${selectedValue === opt ? 'active' : ''}`;
                div.textContent = opt;
                div.onclick = () => {
                    if (mouseDragActive) return;
                    onSelect(opt);
                    // Re-render to update active state
                    renderScrollOptions(containerId, options, opt, onSelect);
                    ensureActiveVisible(containerId);
                };
                container.appendChild(div);
            });
            ensureActiveVisible(containerId);
        }

        function renderMultiScrollOptions(containerId, options, selectedSet, onToggle) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = `scroll-item ${selectedSet.has(opt) ? 'active' : ''}`;
                div.textContent = opt;
                div.onclick = () => {
                    if (mouseDragActive) return;
                    onToggle(opt);
                    // Re-render to update active state
                    renderMultiScrollOptions(containerId, options, selectedSet, onToggle);
                };
                container.appendChild(div);
            });
        }

        function ensureActiveVisible(containerId) {
            const container = document.getElementById(containerId);
            const active = container.querySelector('.scroll-item.active');
            if (!container || !active) return;
            const target = active.offsetLeft + active.offsetWidth / 2 - container.clientWidth / 2;
            container.scrollTo({ left: Math.max(0, target), behavior: 'smooth' });
        }

        function attachSwipeSelect(containerId, options, getSelected, setSelected) {
            const container = document.getElementById(containerId);
            let sx = 0, sy = 0;
            container.addEventListener('touchstart', e => {
                const t = e.touches[0];
                sx = t.clientX;
                sy = t.clientY;
            }, { passive: true });
            container.addEventListener('touchend', e => {
                const t = e.changedTouches[0];
                const dx = t.clientX - sx;
                const dy = t.clientY - sy;
                if (Math.abs(dx) < 25 || Math.abs(dx) < Math.abs(dy)) return;
                const cur = getSelected();
                let idx = options.indexOf(cur);
                if (idx < 0) idx = 0;
                if (dx < 0 && idx < options.length - 1) idx += 1;
                else if (dx > 0 && idx > 0) idx -= 1;
                const next = options[idx];
                if (next === cur) return;
                setSelected(next);
                renderScrollOptions(containerId, options, next, v => { setSelected(v); });
                ensureActiveVisible(containerId);
            }, { passive: true });
        }
        
        function attachMouseDragScroll(containerId) {
            const container = document.getElementById(containerId);
            let down = false, startX = 0, startLeft = 0;
            container.addEventListener('mousedown', e => {
                if (e.button !== 0) return;
                down = true;
                mouseDragActive = false;
                container.classList.add('dragging');
                startX = e.clientX;
                startLeft = container.scrollLeft;
            });
            window.addEventListener('mousemove', e => {
                if (!down) return;
                const dx = e.clientX - startX;
                container.scrollLeft = startLeft - dx;
                if (Math.abs(dx) > 4) mouseDragActive = true;
            }, { passive: true });
            window.addEventListener('mouseup', () => {
                if (!down) return;
                down = false;
                container.classList.remove('dragging');
                mouseDragActive = false;
            });
            container.addEventListener('mouseleave', () => {
                if (!down) return;
                down = false;
                container.classList.remove('dragging');
                mouseDragActive = false;
            });
        }

        // Initialize renderers
        function initUsedFields() {
            renderScrollOptions('container-version', versionOptions, selectedVersion, (val) => { selectedVersion = val; });
            renderScrollOptions('container-condition', conditionOptions, selectedCondition, (val) => { selectedCondition = val; });
            renderMultiScrollOptions('container-repair', repairOptions, selectedRepairs, (val) => {
                if (selectedRepairs.has(val)) selectedRepairs.delete(val);
                else selectedRepairs.add(val);
            });
            attachSwipeSelect('container-version', versionOptions, () => selectedVersion, (v) => { selectedVersion = v; });
            attachSwipeSelect('container-condition', conditionOptions, () => selectedCondition, (v) => { selectedCondition = v; });
            attachMouseDragScroll('container-version');
            attachMouseDragScroll('container-condition');
            attachMouseDragScroll('container-repair');
        }
        
        // Initial call
        initUsedFields();

        // Bottom Sheet Logic
        const sheetOverlay = document.getElementById('sheet-overlay');
        const sheetContent = document.getElementById('sheet-content');
        const sheetTitle = document.getElementById('sheet-title');
        const sheetBody = document.getElementById('sheet-body');

        function openSheet(title, options, onSelect) {
            sheetTitle.textContent = title;
            sheetBody.innerHTML = '';
            
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'sheet-option';
                div.textContent = opt;
                div.onclick = () => {
                    onSelect(opt);
                    closeSheet();
                };
                sheetBody.appendChild(div);
            });

            sheetOverlay.classList.add('visible');
            setTimeout(() => {
                sheetContent.classList.add('visible');
            }, 10);
        }

        function closeSheet() {
            sheetContent.classList.remove('visible');
            setTimeout(() => {
                sheetOverlay.classList.remove('visible');
            }, 300);
        }

        function openRemarkSheet() {
            openSheet('选择备注', remarkOptions, (val) => {
                document.getElementById('remark').value = val;
            });
        }

        function openOtherSheet() {
            openSheet('选择其它', otherOptions, (val) => {
                document.getElementById('other').value = val;
            });
        }

        let currentType = type; // State for current selected type

        function toggleType(selectedType) {
            currentType = selectedType;
            document.getElementById('btn-type-used').classList.toggle('active', selectedType === 'used');
            document.getElementById('btn-type-new').classList.toggle('active', selectedType === 'new');
            if (mode === 'listing') {
                if (selectedType === 'new') {
                    document.getElementById('photo-section-title').style.display = 'none';
                    document.getElementById('photo-card').style.display = 'none';
                    
                    // Hide used fields
                    document.getElementById('row-used-version').style.display = 'none';
                    document.getElementById('row-used-condition').style.display = 'none';
                    document.getElementById('row-used-repair').style.display = 'none';

                    // Show new fields
                    document.getElementById('row-remark').style.display = 'flex';
                    document.getElementById('row-other').style.display = 'flex';
                } else {
                    document.getElementById('photo-section-title').style.display = 'block';
                    document.getElementById('photo-card').style.display = 'block';

                    // Show used fields
                    document.getElementById('row-used-version').style.display = 'flex';
                    document.getElementById('row-used-condition').style.display = 'flex';
                    document.getElementById('row-used-repair').style.display = 'flex';

                    // Hide new fields
                    document.getElementById('row-remark').style.display = 'none';
                    document.getElementById('row-other').style.display = 'none';
                }
            }
        }

        // Display selected product
        if (model) {
            const parts = [brand, series, model, config].filter(Boolean);
            const html = parts.map((seg, idx) => {
                if (idx === 0) return `<span class="sp-seg">${seg}</span>`;
                return `<span class="sp-sep">·</span><span class="sp-seg">${seg}</span>`;
            }).join('');
            document.getElementById('display-model').innerHTML = html;
            document.getElementById('display-detail').style.display = 'none';
        } else {
            // Fallback for direct access
            document.getElementById('display-model').textContent = "未选择机型";
            document.getElementById('display-detail').style.display = 'none';
        }

        // Configure page for mode
        if (mode === 'listing') {
            document.querySelector('.nav-title').textContent = '填写手机信息';
            document.getElementById('detail-section-title').textContent = '上架详情';
            document.getElementById('label-quantity').textContent = '库存';
            document.getElementById('row-price-range').style.display = 'none';
            document.getElementById('row-sell-price').style.display = 'flex';
            document.getElementById('row-deadline').style.display = 'none';
            document.getElementById('type-toggle').style.display = 'flex'; // Show toggle
            const ph = document.getElementById('points-hint'); if (ph) ph.style.display = 'none';

            // Initialize state based on type
            toggleType(type || 'used'); // Default to used if not specified

            document.getElementById('btn-publish').textContent = action === 'edit' ? '保存' : '确认上架';
            if (action === 'edit') {
                if (initStock) document.getElementById('quantity').value = initStock;
                if (initMinPrice) document.getElementById('sell-price').value = initMinPrice;
                document.querySelector('.nav-title').textContent = '编辑上架信息';
            }
        } else {
            // Set default deadline to 3 days later
            const date = new Date();
            date.setDate(date.getDate() + 3);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('deadline').value = dateStr;
            document.getElementById('photo-section-title').style.display = 'none';
            document.getElementById('photo-card').style.display = 'none';
            document.getElementById('type-toggle').style.display = 'flex';
            toggleType(type || 'used');
            if (action === 'edit') {
                document.querySelector('.nav-title').textContent = '编辑求购信息';
                document.getElementById('btn-publish').textContent = '保存';
                if (initQty) document.getElementById('quantity').value = initQty;
                if (initMinPrice) document.getElementById('min-price').value = initMinPrice;
                if (initMaxPrice) document.getElementById('max-price').value = initMaxPrice;
                if (initDeadline) document.getElementById('deadline').value = initDeadline;
            }
        }

        const photos = [];
        const photoGrid = document.getElementById('photo-grid');
        const photoInput = document.getElementById('photo-input');

        function renderPhotos() {
            photoGrid.innerHTML = '';
            photos.forEach((src, idx) => {
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `<img class="photo-img" src="${src}"><span class="photo-remove" onclick="removePhoto(${idx})">×</span>`;
                photoGrid.appendChild(item);
            });
            if (photos.length < 9) {
                const add = document.createElement('div');
                add.className = 'photo-item photo-add';
                add.textContent = '＋';
                add.onclick = () => photoInput.click();
                photoGrid.appendChild(add);
            }
        }

        function removePhoto(index) {
            const src = photos[index];
            photos.splice(index, 1);
            if (src && src.startsWith('blob:')) URL.revokeObjectURL(src);
            renderPhotos();
        }

        photoInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files || []);
            files.forEach(file => {
                if (photos.length >= 9) return;
                const url = URL.createObjectURL(file);
                photos.push(url);
            });
            e.target.value = '';
            renderPhotos();
        });
        renderPhotos();

        function publish() {
            if (mode === 'listing') {
                const quantity = document.getElementById('quantity').value;
                const sellPrice = document.getElementById('sell-price').value;
                const remark = document.getElementById('remark').value;
                const other = document.getElementById('other').value;
                const needPhotos = action === 'edit' ? false : true;
                
                // Validate common fields
                if (!quantity || !sellPrice) {
                    alert('请填写完整信息');
                    return;
                }

                if (currentType === 'used') {
                    if (needPhotos && photos.length === 0) {
                        alert('请上传商品图片');
                        return;
                    }
                    if (!selectedVersion) {
                        alert('请选择版本');
                        return;
                    }
                    if (!selectedCondition) {
                        alert('请选择成色');
                        return;
                    }
                    if (selectedRepairs.size === 0) {
                        alert('请选择拆修和功能');
                        return;
                    }
                } else if (currentType === 'new') {
                     if (!remark) {
                        alert('请选择备注');
                        return;
                    }
                    if (!other) {
                        alert('请选择其它');
                        return;
                    }
                }

                alert(action === 'edit' ? '保存成功！即将返回我的上架...' : '上架成功！即将返回我的上架...');
                location.href = 'my_listings_mockup.html?v=' + new Date().getTime();
            } else {
                const quantity = document.getElementById('quantity').value;
                const minPrice = document.getElementById('min-price').value;
                const maxPrice = document.getElementById('max-price').value;
                if (!quantity || !minPrice || !maxPrice) {
                    alert('请填写完整信息');
                    return;
                }
                if (action === 'edit') {
                    alert('保存成功！即将返回我的求购...');
                    location.href = 'my_requests_mockup.html?v=' + new Date().getTime();
                } else {
                    alert('发布成功！即将返回求购大厅...');
                    location.href = 'listings_mockup.html?v=' + new Date().getTime();
                }
            }
        }
    </script>
</body>
</html>
