[toc]

# 小程序后台接口文档

- 基础地址：`http://localhost:8083`
- 全部接口返回 `application/json`
- 数据均按 `sort` 字段升序排列；逻辑删除（`deleted=1`）的数据已被过滤

## 1. 获取完整字典层级
- 方法与地址：`GET /api/dict/all`
- 功能：返回品牌 → 系列 → 型号 → 配置的完整层级数据
- 说明：该接口的下级对象中父级 ID 字段可能为空（仅包含本级的 `*_id`、`*_name`、`sort` 以及下一级数组）
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/all" -H "Accept: application/json"
```
- 返回示例：
```json
[
  {
    "brand_id": 1,
    "brand_name": "Apple",
    "sort": 1,
    "seriesArr": [
      {
        "series_id": 10,
        "series_name": "iPhone",
        "sort": 1,
        "modelArr": [
          {
            "model_id": 100,
            "model_name": "iPhone 13",
            "sort": 1,
            "specArr": [
              { "spec_id": 1000, "spec_name": "128GB", "sort": 1 },
              { "spec_id": 1001, "spec_name": "256GB", "sort": 2 }
            ]
          }
        ]
      }
    ]
  }
]
```

## 2. 获取所有品牌
- 方法与地址：`GET /api/dict/brands`
- 功能：返回全部品牌的基础信息
- 字段：`brand_id`、`brand_name`、`sort`
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/brands" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "brand_id": 1, "brand_name": "Apple", "sort": 1 },
  { "brand_id": 2, "brand_name": "Huawei", "sort": 2 }
]
```

## 3. 根据品牌获取系列
- 方法与地址：`GET /api/dict/series/{brandId}`
- 功能：根据品牌 ID 返回该品牌下的全部系列
- 路径参数：
  - `brandId`：品牌 ID（必填）
- 字段：`brand_id`、`series_id`、`series_name`、`sort`
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/series/1" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "brand_id": 1, "series_id": 10, "series_name": "iPhone", "sort": 1 },
  { "brand_id": 1, "series_id": 11, "series_name": "iPad",   "sort": 2 }
]
```
- 说明：当 `brandId` 不存在时返回空数组 `[]`

## 4. 根据系列获取型号
- 方法与地址：`GET /api/dict/models/{seriesId}`
- 功能：根据系列 ID 返回该系列下的全部型号
- 路径参数：
  - `seriesId`：系列 ID（必填）
- 字段：`brand_id`、`series_id`、`model_id`、`model_name`、`sort`
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/models/10" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "brand_id": 1, "series_id": 10, "model_id": 100, "model_name": "iPhone 13", "sort": 1 },
  { "brand_id": 1, "series_id": 10, "model_id": 101, "model_name": "iPhone 14", "sort": 2 }
]
```
- 说明：当 `seriesId` 不存在时返回空数组 `[]`

## 5. 根据型号获取配置
- 方法与地址：`GET /api/dict/specs/{modelId}`
- 功能：根据型号 ID 返回该型号下的全部配置
- 路径参数：
  - `modelId`：型号 ID（必填）
- 字段：`brand_id`、`series_id`、`model_id`、`spec_id`、`spec_name`、`sort`
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/specs/100" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "brand_id": 1, "series_id": 10, "model_id": 100, "spec_id": 1000, "spec_name": "128GB", "sort": 1 },
  { "brand_id": 1, "series_id": 10, "model_id": 100, "spec_id": 1001, "spec_name": "256GB", "sort": 2 }
]
```
- 说明：当 `modelId` 不存在时返回空数组 `[]`

## 6. 获取城市列表
- 方法与地址：`GET /api/dict/cities`
- 功能：返回有效城市列表，按 `sort` 升序排列，并将“全国”置于首位
- 规则：仅返回 `valid=1` 的城市；排序依据为 `sort` 字段而非城市名称
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/cities" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "city_code": "000000", "city_name": "全国" },
  { "city_code": "310000", "city_name": "上海" },
  { "city_code": "370100", "city_name": "济南" }
]
```

## 7. 获取新机备注列表
- 方法与地址：`GET /api/dict/phone-remark`
- 功能：返回新机备注选项列表
- 规则：筛选 `type=0` 且 `valid=1` 的记录；按 `sort` 字段升序排列
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/phone-remark" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "id": 1, "remark": "原封" },
  { "id": 2, "remark": "后封" }
]
```

## 8. 获取新机其它备注列表
- 方法与地址：`GET /api/dict/phone-model-remark`
- 功能：返回新机其它备注选项列表
- 规则：筛选 `type=1` 且 `valid=1` 的记录；按 `sort` 字段升序排列
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/phone-model-remark" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "id": 1, "remark": "默认" },
  { "id": 2, "remark": "禁止出省" }
]
```

## 9. 获取二手机版本列表
- 方法与地址：`GET /api/dict/phone-model-version`
- 功能：返回二手机版本选项列表
- 规则：筛选 `type=2` 且 `valid=1` 的记录；按 `sort` 字段升序排列
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/phone-model-version" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "id": 1, "remark": "大陆国行" },
  { "id": 2, "remark": "海外无锁" }
]
```

## 10. 获取二手手机成色列表
- 方法与地址：`GET /api/dict/phone-model-condition`
- 功能：返回二手手机成色选项列表
- 规则：筛选 `type=3` 且 `valid=1` 的记录；按 `sort` 字段升序排列
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/phone-model-condition" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "id": 1, "remark": "全新未拆封" },
  { "id": 2, "remark": "几乎全新" }
]
```

## 11. 获取二手手机维修和功能列表
- 方法与地址：`GET /api/dict/phone-model-maintenance`
- 功能：返回二手手机维修和功能选项列表
- 规则：筛选 `type=4` 且 `valid=1` 的记录；按 `sort` 字段升序排列
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/dict/phone-model-maintenance" -H "Accept: application/json"
```
- 返回示例：
```json
[
  { "id": 1, "remark": "无任何维修" },
  { "id": 2, "remark": "屏幕有维修" }
]
```

## 12. 微信小程序登录
- 方法与地址：`POST /api/wx-login`
- 功能：接收微信小程序的 `code`，换取 openid。如果商户不存在则自动创建（此时部分字段为空）；如果存在则更新 Token 并返回最新商户信息。
- 请求体：
```json
{ "code": "微信小程序登录返回的code" }
```

- curl 示例：
```bash
curl -X POST "http://localhost:8083/api/wx-login" \
  -H "Content-Type: application/json" \
  -d '{ "code": "081......" }'
```
- 返回示例：
```json
{
  "merchant": {
    "id": 1,
    "wechatId": "wx_test_0001",
    "token": "token_0001",
    "wechatName": "张三",
    "merchantName": "张三通讯",
    "merchantPhone": "13800000001",
    "merchantAddress": "济南市历下区泉城路1号",
    "merchantLatitude": 36.666666,
    "merchantLongitude": 117.000000,
    "contactName": "张三",
    "isMember": 1,
    "memberExpireDate": "2026-12-31T23:59:59",
    "registrationDate": "2026-01-10T09:00:00",
    "cancellationDate": null,
    "isValid": 1,
    "createTime": "2026-01-13T08:02:39",
    "updateTime": "2026-01-13T08:02:39",
    "code": null
  }
}
```
- 说明：
  - 若为新用户，返回的 `merchant` 对象中 `merchantName`、`merchantPhone` 等字段可能为 `null`，此时前端应引导用户完善注册信息。
  - 登录成功后，后端会生成新的 `token` 并返回，后续请求需使用该 `token`。


## 13. 获取图形验证码
- 方法与地址：`GET /api/sms/captcha`
- 功能：获取图形验证码图片（Base64），用于发送短信前的校验；需登录。
- 请求头：
  - `Authorization: Bearer <token>`
- 参数：
  - `phone`: 手机号（用于绑定生成的验证码）
- 返回示例：
```json
{
  "imageBase64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAoCAIAAAC..."
}
```

## 14. 发送短信验证码
- 方法与地址：`POST /api/sms/send-code`
- 功能：给指定手机号发送短信验证码，随机生成6位数验证码，有效期5分钟。需提供图形验证码校验。
- 请求头：
  - `Authorization: Bearer <token>`
- 请求体：
```json
{
  "phone": "13800000001",
  "captchaCode": "1234"
}
```
- 说明：
  - 图形验证码与 `wechatId+phone` 绑定，发送短信时只需提供 `captchaCode`。
  - 一个微信号一天最多发送5次。
- curl 示例：
```bash
curl -X POST "http://localhost:8083/api/sms/send-code" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer token_0001" \
  -d '{ "phone": "13800000001", "captchaCode": "1234" }'
```
- 返回示例（成功）：
```json
{ "status": "success" }
```
- 返回示例（失败）：
```json
{ "errorCode": "CAPTCHA_INVALID" }
```

## 15. 更新商户信息
- 方法与地址：`PUT /api/merchants/update`
- 功能：更新商户的基本信息（名称、联系人、电话、地址、经纬度）。
- 请求头：
  - `Authorization: Bearer <token>`
- 请求体：
```json
{
  "merchantName": "张三通讯",
  "contactName": "张三",
  "merchantPhone": "13800000001",
  "merchantAddress": "济南市历下区泉城路1号",
  "merchantLatitude": 36.666666,
  "merchantLongitude": 117.000000,
  "code": "123456"
}
```
- 说明：
  - `code` 字段为手机验证码，当修改手机号时必须提供且验证通过。
  - 经纬度字段 `merchantLatitude` 和 `merchantLongitude` 为必填项。
- curl 示例：
```bash
curl -X PUT "http://localhost:8083/api/merchants/update" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer token_0001" \
  -d '{
    "merchantName": "张三通讯",
    "contactName": "张三",
    "merchantPhone": "13800000001",
    "merchantAddress": "济南市历下区泉城路1号",
    "merchantLatitude": 36.666666,
    "merchantLongitude": 117.000000,
    "code": "123456"
  }'
```
- 返回示例：
```json
{
  "id": 1,
  "wechatId": "wx_test_0001",
  "token": "token_0001",
  "wechatName": "张三",
  "merchantName": "张三通讯",
  "merchantPhone": "13800000001",
  "merchantAddress": "济南市历下区泉城路1号",
  "merchantLatitude": 36.666666,
  "merchantLongitude": 117.000000,
  "contactName": "张三",
  "isMember": 1,
  "memberExpireDate": "2026-12-31T23:59:59",
  "registrationDate": "2026-01-10T09:00:00",
  "cancellationDate": null,
  "isValid": 1,
  "createTime": "2026-01-13T08:02:39",
  "updateTime": "2026-01-13T08:02:39",
  "code": null
}
```

## 16. 查询商户已经上架了的商品
- 方法与地址：`GET /api/merchants/products`
- 功能：分页查询当前登录商户已上架的商品列表，按更新时间倒序排列。
- 请求头：
  - `Authorization: Bearer <token>`
- 参数：
  - `page`: 页码，默认 0
  - `size`: 每页数量，默认 10
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/merchants/products?page=0&size=10" \
  -H "Authorization: Bearer token_0001"
```
- 返回示例：
```json
{
  "content": [
    {
      "id": 1,
      "brand": { "id": 1, "brandName": "Apple" },
      "series": { "id": 10, "seriesName": "iPhone" },
      "model": { "id": 100, "modelName": "iPhone 13" },
      "spec": { "id": 1000, "specName": "128GB" },
      "price": 5000,
      "stock": 10,
      "isValid": 1,
      "updateTime": "2026-01-14T10:00:00",
      "listingTime": "2026-01-14T09:00:00",
      "productType": 0,
      "cityCode": "310000",
      "description": "全新未拆封"
    }
  ],
  "pageable": {
    "sort": { "sorted": true, "unsorted": false, "empty": false },
    "offset": 0,
    "pageNumber": 0,
    "pageSize": 10,
    "paged": true,
    "unpaged": false
  },
  "totalPages": 5,
  "totalElements": 50,
  "last": false,
  "size": 10,
  "number": 0,
  "sort": { "sorted": true, "unsorted": false, "empty": false },
  "numberOfElements": 10,
  "first": true,
  "empty": false
}
```
- 说明：
  - 返回数据为 Spring Data JPA 的 `Page` 对象结构。
  - `content` 字段为商品列表。
  - 若商户会员已过期，返回 400 错误。

## 17. 查询商户发布的求购商品信息
- 方法与地址：`GET /api/merchants/products/buy`
- 功能：分页查询当前登录商户发布的求购信息，按更新时间倒序排列。
- 请求头：
  - `Authorization: Bearer <token>`
- 参数：
  - `page`: 页码，默认 0
  - `size`: 每页数量，默认 10
- curl 示例：
```bash
curl -X GET "http://localhost:8083/api/merchants/products/buy?page=0&size=10" \
  -H "Authorization: Bearer token_0001"
```
- 返回示例：
```json
{
  "content": [
    {
      "id": 1,
      "merchantId": 1,
      "brandId": 1,
      "seriesId": 10,
      "modelId": 100,
      "specId": 1000,
      "cityCode": "370100",
      "productType": 0,
      "buyCount": 1,
      "minPrice": 9000,
      "maxPrice": 10000,
      "deadline": "2026-08-01T23:59:59",
      "costIntegral": 100,
      "isValid": 1,
      "createTime": "2026-01-14T10:00:00",
      "updateTime": "2026-01-14T10:00:00"
    }
  ],
  "pageable": {
    "sort": { "sorted": true, "unsorted": false, "empty": false },
    "offset": 0,
    "pageNumber": 0,
    "pageSize": 10,
    "paged": true,
    "unpaged": false
  },
  "totalPages": 1,
  "totalElements": 1,
  "last": true,
  "size": 10,
  "number": 0,
  "sort": { "sorted": true, "unsorted": false, "empty": false },
  "numberOfElements": 1,
  "first": true,
  "empty": false
}
```
- 说明：
  - 返回数据为 Spring Data JPA 的 `Page` 对象结构。
  - `content` 字段为求购记录列表。
  - 若商户会员已过期，返回 400 错误。

## 18. 商家上架新机、二手机
- 方法与地址：`POST /api/merchants/products`
- 功能：当前登录商户上架新机或二手机商品，成功后返回创建好的商品信息。
- 请求头：
  - `Authorization: Bearer <token>`
- 请求体：
  - 公共字段：
    - `brand`: 品牌对象，至少包含 `id`
    - `series`: 系列对象，至少包含 `id`
    - `model`: 型号对象，至少包含 `id`
    - `spec`: 配置对象，至少包含 `id`
    - `cityCode`: 城市编码
    - `productType`: 商品类型，`0` 新机，`1` 二手机（必填）
    - `description`: 产品描述
    - `price`: 价格（>0 的整数）
    - `stock`: 库存（>=0 的整数）
  - 新机（`productType = 0`）额外必填字段：
    - `remark`: 新机备注，如“原封”“后封”等
    - `otherRemark`: 新机其它备注，如“当天发货”等
  - 二手机（`productType = 1`）额外必填字段：
    - `secondHandVersion`: 二手机版本，如“大陆国行”“海外无锁”等
    - `secondHandCondition`: 成色，如“几乎全新”等
    - `secondHandFunction`: 拆修和功能情况，如“无任何维修”等
    - `images`: 图片列表，数组，至少包含 1 条有效图片
      - 每个元素：
        - `imageUrl`: 图片完整 URL
- 请求体示例（上架新机）：
```json
{
  "brand": { "id": 1 },
  "series": { "id": 10 },
  "model": { "id": 100 },
  "spec": { "id": 1000 },
  "cityCode": "370100",
  "productType": 0,
  "remark": "保证全国纯原",
  "otherRemark": "当天发货",
  "description": "全新未拆封，正品保证",
  "price": 9999,
  "stock": 10
}
```
- 请求体示例（上架二手机）：
```json
{
  "brand": { "id": 1 },
  "series": { "id": 10 },
  "model": { "id": 101 },
  "spec": { "id": 1001 },
  "cityCode": "510100",
  "productType": 1,
  "secondHandVersion": "大陆国行",
  "secondHandCondition": "细微磕碰划痕",
  "secondHandFunction": "无任何维修",
  "description": "个人自用一手，成色很好",
  "price": 3500,
  "stock": 1,
  "images": [
    { "imageUrl": "https://example.com/products/iphone15_1.jpg" }
  ]
}
```
- curl 示例：
```bash
curl -X POST "http://localhost:8083/api/merchants/products" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer token_0001" \
  -d '{
    "brand": { "id": 1 },
    "series": { "id": 10 },
    "model": { "id": 100 },
    "spec": { "id": 1000 },
    "cityCode": "370100",
    "productType": 0,
    "remark": "保证全国纯原",
    "otherRemark": "当天发货",
    "description": "全新未拆封，正品保证",
    "price": 9999,
    "stock": 10
  }'
```
- 返回示例：
```json
{
  "id": 1,
  "merchant": { "id": 1 },
  "brand": { "id": 1, "brandName": "苹果" },
  "series": { "id": 10, "seriesName": "iPhone" },
  "model": { "id": 100, "modelName": "iPhone 16 Pro Max" },
  "spec": { "id": 1000, "specName": "1TB 黑色" },
  "cityCode": "370100",
  "productType": 0,
  "remark": "保证全国纯原",
  "otherRemark": "当天发货",
  "secondHandVersion": null,
  "secondHandCondition": null,
  "secondHandFunction": null,
  "batteryStatus": null,
  "description": "全新未拆封，正品保证",
  "price": 9999,
  "stock": 10,
  "listingTime": "2026-01-14T09:00:00",
  "isValid": 1,
  "createTime": "2026-01-14T09:00:00",
  "updateTime": "2026-01-14T09:00:00",
  "images": [
    { "id": 1, "imageUrl": "https://example.com/products/iphone16promax_1.jpg" }
  ]
}
```
- 说明：
  - 该接口只能操作当前登录商户自身的商品。
  - 若商户未登录，返回 401。
  - 若商户会员已过期，返回 400，错误信息为“商户会员已过期”。
  - 若参数校验失败（例如缺少必填字段），返回 400，错误信息为对应的中文提示。
